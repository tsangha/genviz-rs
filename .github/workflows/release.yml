# This file was generated by cargo-dist and may be regenerated with `cargo dist init`.
# DO NOT EDIT MANUALLY â€” run `cargo dist init` to regenerate.

name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Create the GitHub Release so uploads can target it.
  create-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Get tag
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: gh release create "$TAG" --draft --title "$TAG" --generate-notes

  # Build platform-specific binaries.
  build-binaries:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-14
          - target: x86_64-apple-darwin
            os: macos-13
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
          - target: x86_64-pc-windows-msvc
            os: windows-2022
    runs-on: ${{ matrix.os }}
    env:
      TAG: ${{ needs.create-release.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Build
        run: cargo build --release --target ${{ matrix.target }} --features cli
      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../genviz-${TAG}-${{ matrix.target }}.tar.gz genviz
          cd ../../..
      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          7z a ../../../genviz-${TAG}-${{ matrix.target }}.zip genviz.exe
          cd ../../..
        shell: bash
      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "$TAG" genviz-${TAG}-${{ matrix.target }}.*

  # Generate installer scripts.
  build-installers:
    needs: create-release
    runs-on: ubuntu-latest
    env:
      TAG: ${{ needs.create-release.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-dist
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/axodotdev/cargo-dist/releases/latest/download/cargo-dist-installer.sh | sh
      - name: Generate installers
        run: dist build --artifacts=global --no-local-paths
      - name: Upload installers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in target/distrib/*; do
            [ -f "$file" ] && gh release upload "$TAG" "$file"
          done

  # Publish the release (un-draft it) once all artifacts are uploaded.
  publish-release:
    needs: [create-release, build-binaries, build-installers]
    runs-on: ubuntu-latest
    env:
      TAG: ${{ needs.create-release.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit "$TAG" --draft=false
